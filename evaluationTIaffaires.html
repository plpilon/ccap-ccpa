<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://drive.google.com/uc?export=download&id=1i7FOimukyvfL_7VixD26O7PHzSzuSPbj">

  <title>Évaluation des compétences - CCAP Campus</title>
  <style>
  :root{
    --brand:#A4262C;
    --brand-dark:#7F1D22;
    --brand-soft:#FCE8EA;
    --bg:#F3F4F6;
    --surface:#FFFFFF;
    --surface-2:#FAFAFA;
    --text:#1F2937;
    --muted:#6B7280;
    --border:#D1D5DB;
    --border-2:#E5E7EB;
    --focus: rgba(164, 38, 44, .25);
    --good:#0F766E;
    --warn:#B45309;
    --bad:#B91C1C;
    --radius:14px;
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
    color: var(--text);
    line-height:1.35;
    background:
      radial-gradient(900px 700px at 50% 35%, rgba(255,255,255,.92) 0%, rgba(255,255,255,0) 60%),
      linear-gradient(135deg, #f2b7b7 0%, #f6e9e9 35%, #e9f0fb 65%, #bcd2f5 100%);
    background-attachment: fixed;
  }

  .ccap-topbar{
    background: var(--brand);
    color:#fff;
    height:72px;
    display:flex;
    align-items:center;
    box-shadow: 0 2px 0 rgba(0,0,0,.08);
  }
  .ccap-topbar .inner{
    max-width: 1100px;
    width:100%;
    margin: 0 auto;
    padding: 0 16px;
    display:flex;
    align-items:center;
    gap:14px;
  }
  .ccap-mark{
    width:36px;
    height:36px;
    border-radius:8px;
    background: rgba(255,255,255,.12);
    display:grid;
    place-items:center;
    flex:0 0 auto;
  }
  .ccap-title{
    font-size: 22px;
    font-weight:700;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ccap-actions{
    margin-left:auto;
    display:flex;
    gap:14px;
    align-items:center;
    font-size:14px;
    opacity:.95;
  }

  .ccap-breadcrumb{
    background:#F9FAFB;
    border-bottom:1px solid var(--border);
    font-size:13px;
  }
  .ccap-breadcrumb .inner{
    max-width:1100px;
    margin:0 auto;
    padding:8px 16px;
    display:flex;
    align-items:center;
    gap:6px;
    color:var(--muted);
  }
  .ccap-breadcrumb a{
    color:var(--brand);
    text-decoration:none;
    font-weight:600;
  }
  .ccap-breadcrumb a:hover{
    text-decoration:underline;
  }
  .ccap-breadcrumb .sep{
    color:#9CA3AF;
  }
  .ccap-breadcrumb .current{
    color:#374151;
    font-weight:600;
  }
  .ccap-breadcrumb .login-area{
    margin-left: auto;
  }

  .wrap{
    max-width: 1100px;
    margin: 0 auto;
    padding: 18px 16px 80px;
  }

  .header{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:14px;
  }
  .title{
    font-size:24px;
    font-weight:700;
    margin:0;
  }
  .note{
    color:var(--muted);
    font-size:13px;
    margin-top:6px;
  }

  .pill{
    display:inline-flex;
    gap:8px;
    align-items:center;
    border:1px solid var(--border);
    background: var(--surface);
    border-radius:999px;
    padding:8px 14px;
    color:var(--text);
    font-size:12px;
    white-space:nowrap;
    font-weight:600;
  }
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

  .grid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
  }
  @media (max-width: 900px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    border:1px solid var(--border);
    background: var(--surface);
    border-radius: var(--radius);
    padding:16px;
    box-shadow: 0 10px 22px rgba(0,0,0,.06);
  }
  .card h2{
    margin:0 0 12px 0;
    font-size:13px;
    color:var(--muted);
    font-weight:700;
    letter-spacing:.04em;
    text-transform:uppercase;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }

  .field label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin:0 0 6px 0;
  }
  .field input, .field select, textarea{
    width:100%;
    box-sizing:border-box;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid var(--border);
    background: var(--surface-2);
    color:var(--text);
    outline:none;
  }
  .field input:focus, textarea:focus{
    border-color: var(--brand);
    box-shadow: 0 0 0 4px var(--focus);
    background: #fff;
  }

  textarea{
    min-height:160px;
    resize:vertical;
    font-size:14px;
    line-height:1.45;
  }

  .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  button{
    border:1px solid transparent;
    background: var(--brand);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    font-size:13px;
  }
  button:hover{ background: var(--brand-dark); }
  button:disabled{ cursor:not-allowed; opacity:.55; }

  .ghost{
    background: #fff;
    color: var(--brand);
    border:1px solid var(--brand);
  }
  .ghost:hover{
    background: var(--brand-soft);
  }

  .danger{
    background: #fff;
    color: var(--bad);
    border:1px solid var(--bad);
  }
  .danger:hover{ background: #FEE2E2; }

  .kpis{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
  }
  @media (max-width: 900px){
    .kpis{grid-template-columns: repeat(2, 1fr)}
  }
  .kpi{
    border:1px solid var(--border-2);
    background: #fff;
    border-radius:12px;
    padding:10px;
  }
  .kpi .k{font-size:12px; color:var(--muted); margin-bottom:6px}
  .kpi .v{font-size:18px; font-weight:800; color: var(--text)}

  .target{
    border:1px solid var(--border);
    background: #fff;
    border-radius:12px;
    padding:12px;
    font-size:14px;
    user-select:none;
    -webkit-user-select:none;
  }
  .target small{
    display:block;
    color:var(--muted);
    margin-bottom:6px;
    font-size:12px;
  }

  .status{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background: #fff;
    color:var(--muted);
    font-size:13px;
    white-space:pre-wrap;
  }

  .ok{color:var(--good)}
  .warn{color:var(--warn)}
  .bad{color:var(--bad)}

  .hr{height:1px; background: var(--border-2); margin:12px 0}

  .stepcard{display:none;}
  .stepcard.active{display:block;}

  .modal-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    display: grid;
    place-items: center;
    z-index: 1000;
    padding: 20px;
  }
  .modal-content{
    background: var(--surface);
    border-radius: var(--radius);
    padding: 24px;
    max-width: 480px;
    width: 100%;
    box-shadow: 0 20px 50px rgba(0,0,0,.3);
  }
  .modal-content h2{
    margin: 0 0 8px 0;
    font-size: 24px;
    color: var(--text);
  }
  .modal-content > p{
    color: var(--muted);
    margin: 0 0 20px 0;
    font-size: 14px;
  }
  .modal-content label{
    display: block;
    font-size: 13px;
    color: var(--text);
    font-weight: 600;
    margin: 0 0 6px 0;
  }
  .modal-content input{
    width: 100%;
    box-sizing: border-box;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text);
    outline: none;
    font-size: 14px;
    margin-bottom: 14px;
  }
  .modal-content input:focus{
    border-color: var(--brand);
    box-shadow: 0 0 0 3px var(--focus);
    background: #fff;
  }
  .modal-buttons{
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .console-footer{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(31, 41, 55, 0.95);
    backdrop-filter: blur(8px);
    color: #9CA3AF;
    font-size: 12px;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 20px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    border-top: 1px solid rgba(255,255,255,.1);
    z-index: 100;
  }
  .console-footer .status-dot{
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6B7280;
  }
  .console-footer .status-dot.connected{
    background: var(--good);
    box-shadow: 0 0 8px var(--good);
  }
  .console-footer strong{
    color: #E5E7EB;
  }
  .console-footer button{
    padding: 4px 10px;
    font-size: 11px;
    border-radius: 6px;
    margin-left: auto;
  }
  .console-footer .token-display{
    color: #10B981;
  }

  a{color: var(--brand);}
  a:hover{color: var(--brand-dark);}
  </style>
</head>
<body>
  <div class="ccap-topbar">
    <div class="inner">
      <div class="ccap-mark" aria-hidden="true">
        <img src="https://plpilon.github.io/ccap-ccpa/ccap-ccpa.svg" height="40px">
      </div>
      <div class="ccap-title">Conseil canadien de l'administration publique</div>
      <div class="ccap-actions"></div>
    </div>
  </div>

  <nav class="ccap-breadcrumb" aria-label="Fil d'Ariane">
    <div class="inner">
      <a href="#">CCAP Campus</a>
      <span class="sep">›</span>
      <span class="current">Évaluation des compétences en technologies d'affaires</span>
      <div class="login-area">
        <button id="btnLogin" type="button">Ouvrir une session</button>
        <span id="loginPill" class="pill" style="display:none;">
          Connecté <span class="mono" id="breadcrumbToken"></span>
        </span>
      </div>
    </div>
  </nav>

  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="title">Évaluation des compétences en technologies d'affaires</h1>
        <div class="note">3 étapes, 50 minutes.</div>
      </div>
      <div class="pill">
        <span>Étape</span>
        <strong id="pillStep">1</strong>
        <span class="mono" id="pillToken" title="Token étudiant"></span>
      </div>
    </div>

    <!-- STEP 1: TYPING TEST -->
    <div class="stepcard card active" id="step1">
      <h2>Étape 1, Test de frappe</h2>

      <div class="grid">
        <div class="card">
          <h2>Contrôles</h2>

          <div class="kpis">
            <div class="kpi">
              <div class="k">Essai</div>
              <div class="v" id="kAttempt">0 / 3</div>
            </div>
            <div class="kpi">
              <div class="k">Temps essai (s)</div>
              <div class="v" id="kAttemptTime">60</div>
            </div>
            <div class="kpi">
              <div class="k">Temps étape (s)</div>
              <div class="v" id="kGlobalTime">300</div>
            </div>
            <div class="kpi">
              <div class="k">Meilleur MPM</div>
              <div class="v" id="kBest">0.0</div>
            </div>
          </div>

          <div class="btns">
            <button id="btnStart">Commencer</button>
            <button id="btnFinish" class="ghost" disabled>Terminer l'essai</button>
            <button id="btnNext" class="ghost" disabled>Essai suivant</button>
            <button id="btnForceSubmit" class="danger" disabled>Soumettre maintenant</button>
          </div>

          <div class="status" id="statusBox">Prêt. Clique sur Commencer.</div>

          <div class="note">
            Règle auto: soumission au plus tôt entre 3 essais complétés ou 5 minutes écoulées depuis Commencer.
          </div>
        </div>

        <div class="card">
          <h2>Texte à recopier</h2>
          <div class="target" id="targetBox">
            <small id="targetMeta">Texte 1 sur 3</small>
            <div id="targetText"></div>
          </div>

          <div class="hr"></div>

          <h2>Zone de frappe</h2>
          <textarea id="typingInput" placeholder="Tape ici quand l'essai est en cours" disabled></textarea>

          <div class="note">
            Conseils: garde un rythme stable, vise la précision. Les corrections (Backspace) sont comptées.
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="stepcard card" id="step2">
      <h2>Étape 2</h2>

      <div class="status" id="step2Status">
        Token: <span class="mono" id="tokenStep2"></span>
        <div class="hr"></div>
        Temps restant: <span class="mono" id="step2Countdown">1 200</span> secondes
        <div class="hr"></div>
        <a id="step2DocLink" href="ETAPE2_DOCUMENT_A_CORRIGER.docx" download>Télécharger le document Word à corriger</a>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Remise du fichier</h2>
        <div class="field">
          <label>Sélectionne ton fichier .docx corrigé</label>
          <input id="step2File" type="file" accept=".docx" />
        </div>
        <div class="btns">
          <button id="btnUploadStep2">Soumettre mon fichier</button>
          <button id="btnToStep3" class="ghost" disabled>Aller à l'étape 3</button>
        </div>
        <div class="status" id="step2UploadStatus">Quand tu soumets, l'étape 3 sera débloquée.</div>
      </div>

      <div class="btns" style="margin-top:12px">
        <button class="ghost" id="btnBackToStep1">Retour à l'étape 1</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div class="stepcard card" id="step3">
      <h2>Étape 3</h2>
      <div class="status">
        Token détecté: <span class="mono" id="tokenStep3"></span>
        <div class="hr"></div>
        Mets ici le contenu de ton étape 3.
      </div>
      <div class="btns">
        <button class="ghost" id="btnBackToStep2">Retour à l'étape 2</button>
      </div>
    </div>
  </div>

  <!-- Console Footer -->
  <div class="console-footer">
    <span class="status-dot" id="statusDot"></span>
    <span>Statut: <strong id="consoleStatus">non connecté</strong></span>
    <span id="consoleTokenArea" style="display:none;">Jeton: <span class="token-display" id="consoleToken"></span></span>
    <button id="btnConsoleAction" type="button" class="ghost" style="display:none;">Déconnexion</button>
  </div>

  <!-- Modal Login -->
  <div id="loginModal" hidden role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-overlay">
      <div class="modal-content">
        <h2 id="loginTitle">Se connecter</h2>
        <p>Renseigne ton identité. Un token sera généré ou réutilisé.</p>

        <form id="loginForm">
          <div>
            <label for="modalFirstName">Prénom</label>
            <input id="modalFirstName" autocomplete="given-name" />
          </div>
          <div>
            <label for="modalLastName">Nom</label>
            <input id="modalLastName" autocomplete="family-name" />
          </div>
          <div>
            <label for="modalStudentId">Numéro étudiant ou courriel</label>
            <input id="modalStudentId" autocomplete="username" required />
          </div>

          <div class="modal-buttons">
            <button type="submit">Se connecter</button>
            <button type="button" id="btnCloseModal" class="ghost">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const MAX_ATTEMPTS = 3;
const ATTEMPT_DURATION_SEC = 60;
const GLOBAL_LIMIT_SEC = 5 * 60;
const STEP2_LIMIT_SEC = 20 * 60;
const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxma1DUGVpepCZcwWRViILwftO1d8W_dEAwdX-tsIduxGrt_98jUOSUzrMKl061tLUsxw/exec";

/* =========================
   TEXTS
========================= */
const TEXTS = [
  "Dans un milieu de travail, la qualité des données dépend autant des outils que des habitudes. Un bon fichier, c'est un fichier clair, cohérent, et facile à reprendre par quelqu'un d'autre. Tu n'écris pas seulement pour toi, tu écris pour l'équipe.",
  "La technologie peut accélérer une tâche, mais elle peut aussi amplifier une erreur. Avant d'automatiser, il faut comprendre le problème, valider les entrées, et vérifier les résultats. Une minute de vérification peut éviter une journée de reprise.",
  "Un message professionnel doit être simple et précis. Explique le contexte, dis ce que tu proposes, et indique ce que tu attends de l'autre personne. Si tu peux, ajoute une échéance. La clarté réduit les allers retours et aide tout le monde."
];

/* =========================
   IN-MEMORY STORAGE
========================= */
let identityStore = null;

/* =========================
   STATE
========================= */
let state = {
  token: "",
  step: 1,
  globalStartMs: null,
  globalTimerId: null,
  attemptActive: false,
  attemptStartMs: null,
  attemptTickId: null,
  attempts: [],
  attemptsCompleted: 0,
  focusLost: 0,
  backspaces: 0,
  isSubmitted: false,
  currentTextIndex: 0
};

let step2StartMs = null;
let step2TickId = null;
let step2Timeouts = [];

/* =========================
   IDENTITY HELPERS
========================= */
function getUrlParam(name){
  return new URLSearchParams(location.search).get(name);
}

function genToken(){
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  const bytes = new Uint8Array(16);
  (crypto || window.msCrypto).getRandomValues(bytes);
  return [...bytes].map(b => b.toString(16).padStart(2,"0")).join("");
}

function loadIdentity(){
  return identityStore;
}

function saveIdentity(obj){
  identityStore = obj;
}

function clearIdentity(){
  identityStore = null;
}

function isLoggedIn(){
  const id = loadIdentity();
  return !!(id && id.token && id.studentId);
}

function tokenShort(t){
  if (!t) return "";
  return t.slice(0, 8);
}

function updateLoginUI(){
  const id = loadIdentity();
  const loggedIn = isLoggedIn();

  // Breadcrumb area
  const btnLogin = document.getElementById("btnLogin");
  const loginPill = document.getElementById("loginPill");
  const breadcrumbToken = document.getElementById("breadcrumbToken");

  if (loggedIn) {
    btnLogin.style.display = "none";
    loginPill.style.display = "inline-flex";
    breadcrumbToken.textContent = tokenShort(id.token);
  } else {
    btnLogin.style.display = "inline-block";
    loginPill.style.display = "none";
  }

  // Console footer
  const statusDot = document.getElementById("statusDot");
  const consoleStatus = document.getElementById("consoleStatus");
  const consoleTokenArea = document.getElementById("consoleTokenArea");
  const consoleToken = document.getElementById("consoleToken");
  const btnConsoleAction = document.getElementById("btnConsoleAction");

  if (loggedIn) {
    statusDot.classList.add("connected");
    consoleStatus.textContent = "connecté";
    consoleTokenArea.style.display = "inline";
    consoleToken.textContent = tokenShort(id.token);
    btnConsoleAction.style.display = "inline-block";
    btnConsoleAction.textContent = "Déconnexion";
  } else {
    statusDot.classList.remove("connected");
    consoleStatus.textContent = "non connecté";
    consoleTokenArea.style.display = "none";
    btnConsoleAction.style.display = "none";
  }

  // Update pill token
  document.getElementById("pillToken").textContent = loggedIn ? tokenShort(id.token) : "";
}

function openModal(){
  document.getElementById("loginModal").hidden = false;
  const cached = loadIdentity();
  if (cached){
    document.getElementById("modalFirstName").value = cached.firstName || "";
    document.getElementById("modalLastName").value = cached.lastName || "";
    document.getElementById("modalStudentId").value = cached.studentId || "";
  }
  document.getElementById("modalStudentId").focus();
}

function closeModal(){
  document.getElementById("loginModal").hidden = true;
}

/* =========================
   STEP 2 TIMER
========================= */
function clearStep2Timer(){
  step2Timeouts.forEach(id => clearTimeout(id));
  step2Timeouts = [];
  if (step2TickId) clearInterval(step2TickId);
  step2TickId = null;
}

function startStep2Timer(){
  clearStep2Timer();
  step2StartMs = Date.now();

  step2Timeouts.push(setTimeout(() => {
    if (state.step === 2) alert("Il reste 2 minutes.");
  }, (STEP2_LIMIT_SEC - 120) * 1000));

  step2Timeouts.push(setTimeout(() => {
    if (state.step === 2) alert("Il reste 1 minute.");
  }, (STEP2_LIMIT_SEC - 60) * 1000));

  step2Timeouts.push(setTimeout(() => {
    if (state.step === 2) {
      alert("Temps écoulé. Soumets immédiatement ton fichier.");
      const st = document.getElementById("step2UploadStatus");
      if (st) st.textContent = "Temps écoulé. Soumets immédiatement ton fichier.";
    }
  }, STEP2_LIMIT_SEC * 1000));

  step2TickId = setInterval(() => {
    const elapsed = Math.floor((Date.now() - step2StartMs) / 1000);
    const remaining = Math.max(0, STEP2_LIMIT_SEC - elapsed);
    const el = document.getElementById("step2Countdown");
    if (el) el.textContent = String(remaining);
    if (remaining <= 0) clearStep2Timer();
  }, 250);
}

/* =========================
   HELPERS
========================= */
function setUrl(step, token){
  const u = new URL(location.href);
  u.searchParams.set("step", String(step));
  u.searchParams.set("token", token);
  history.replaceState({}, "", u.toString());
}

function showStep(step){
  document.querySelectorAll(".stepcard").forEach(el => el.classList.remove("active"));
  document.getElementById("step" + step).classList.add("active");
  document.getElementById("pillStep").textContent = String(step);
}

function clamp(n, a, b){ return Math.min(b, Math.max(a, n)); }
function round1(x){ return Math.round(x * 10) / 10; }

function setStatus(msg, cls){
  const el = document.getElementById("statusBox");
  el.classList.remove("ok","warn","bad");
  if (cls) el.classList.add(cls);
  el.textContent = msg;
}

function getElapsedSec(startMs){
  return Math.max(0, Math.floor((Date.now() - startMs) / 1000));
}

function bestAttempt(){
  if (state.attempts.length === 0) return null;
  return state.attempts.slice().sort((a,b)=>{
    if (b.netWpm !== a.netWpm) return b.netWpm - a.netWpm;
    return b.accuracyPct - a.accuracyPct;
  })[0];
}

function computeMetrics(targetText, typedText, durationSec){
  const totalTyped = typedText.length;
  let correctChars = 0;
  let errors = 0;

  const n = Math.max(targetText.length, typedText.length);
  for (let i = 0; i < n; i++){
    const t = targetText[i] ?? "";
    const c = typedText[i] ?? "";
    if (c === "") continue;
    if (c === t) correctChars++;
    else errors++;
  }

  const minutes = durationSec / 60;
  const grossWpm = minutes > 0 ? (totalTyped / 5) / minutes : 0;
  const netWpm = Math.max(0, grossWpm - (errors / minutes));
  const accuracyPct = totalTyped > 0 ? (correctChars / totalTyped) * 100 : 0;

  return {
    grossWpm: round1(grossWpm),
    netWpm: round1(netWpm),
    accuracyPct: round1(accuracyPct),
    errors,
    correctChars,
    totalTyped,
    durationSec
  };
}

function setTargetText(index){
  state.currentTextIndex = index;
  const meta = document.getElementById("targetMeta");
  const text = document.getElementById("targetText");
  meta.textContent = `Texte ${index + 1} sur 3`;
  text.textContent = TEXTS[index];
}

function startGlobalTimer(){
  state.globalStartMs = Date.now();
  state.globalTimerId = setInterval(()=>{
    const elapsed = getElapsedSec(state.globalStartMs);
    const remaining = clamp(GLOBAL_LIMIT_SEC - elapsed, 0, GLOBAL_LIMIT_SEC);
    document.getElementById("kGlobalTime").textContent = String(remaining);
    if (elapsed >= GLOBAL_LIMIT_SEC){
      stopAttemptIfRunning(true);
      autoSubmit("time_limit");
    }
  }, 200);
}

function stopGlobalTimer(){
  if (state.globalTimerId) clearInterval(state.globalTimerId);
  state.globalTimerId = null;
}

function startAttempt(){
  if (state.attemptActive) return;
  if (state.attemptsCompleted >= MAX_ATTEMPTS) return;

  setTargetText(state.attemptsCompleted % 3);

  state.attemptActive = true;
  state.attemptStartMs = Date.now();
  document.getElementById("typingInput").disabled = false;
  document.getElementById("typingInput").value = "";
  document.getElementById("typingInput").focus();

  document.getElementById("btnFinish").disabled = false;
  document.getElementById("btnForceSubmit").disabled = false;
  document.getElementById("btnNext").disabled = true;

  setStatus(`Essai ${state.attemptsCompleted + 1} en cours.`, "warn");

  state.attemptTickId = setInterval(()=>{
    const elapsed = getElapsedSec(state.attemptStartMs);
    const remaining = clamp(ATTEMPT_DURATION_SEC - elapsed, 0, ATTEMPT_DURATION_SEC);
    document.getElementById("kAttemptTime").textContent = String(remaining);
    if (elapsed >= ATTEMPT_DURATION_SEC){
      finishAttempt("time_up");
    }
  }, 100);
}

function stopAttemptIfRunning(forceFinish){
  if (!state.attemptActive) return;
  if (forceFinish) finishAttempt("forced_by_global");
  else {
    clearInterval(state.attemptTickId);
    state.attemptTickId = null;
    state.attemptActive = false;
    document.getElementById("typingInput").disabled = true;
  }
}

function finishAttempt(reason){
  if (!state.attemptActive) return;

  clearInterval(state.attemptTickId);
  state.attemptTickId = null;

  const attemptEndMs = Date.now();
  const actualDuration = clamp(Math.floor((attemptEndMs - state.attemptStartMs)/1000), 1, ATTEMPT_DURATION_SEC);

  const target = TEXTS[state.currentTextIndex];
  const typed = document.getElementById("typingInput").value;

  const metrics = computeMetrics(target, typed, actualDuration);

  state.attemptsCompleted++;
  state.attempts.push({
    attemptNo: state.attemptsCompleted,
    textNo: state.currentTextIndex + 1,
    reason,
    startedAt: new Date(state.attemptStartMs).toISOString(),
    endedAt: new Date(attemptEndMs).toISOString(),
    backspaces: state.backspaces,
    ...metrics
  });

  state.backspaces = 0;
  state.attemptActive = false;
  document.getElementById("typingInput").disabled = true;
  document.getElementById("btnFinish").disabled = true;

  document.getElementById("kAttempt").textContent = `${state.attemptsCompleted} / ${MAX_ATTEMPTS}`;
  const best = bestAttempt();
  document.getElementById("kBest").textContent = best ? String(best.netWpm.toFixed(1)) : "0.0";

  setStatus(
    `Essai ${state.attemptsCompleted} terminé.\nNet WPM: ${metrics.netWpm.toFixed(1)}\nPrécision: ${metrics.accuracyPct.toFixed(1)}%\nErreurs: ${metrics.errors}\nDurée: ${metrics.durationSec}s`,
    "ok"
  );

  if (state.attemptsCompleted >= MAX_ATTEMPTS){
    document.getElementById("btnNext").disabled = true;
    autoSubmit("attempt_limit");
  } else {
    document.getElementById("btnNext").disabled = false;
  }
}

function buildPayload(reason){
  const best = bestAttempt();
  const id = loadIdentity();

  return {
    token: state.token,
    step: 1,
    reason,
    studentId: id ? id.studentId : "",
    firstName: id ? id.firstName : "",
    lastName: id ? id.lastName : "",
    attemptsCompleted: state.attemptsCompleted,
    attempts: state.attempts,
    best: best,
    focusLost: state.focusLost,
    totalTimeSec: state.globalStartMs ? getElapsedSec(state.globalStartMs) : null,
    userAgent: navigator.userAgent
  };
}

async function autoSubmit(reason){
  if (state.isSubmitted) return;
  state.isSubmitted = true;

  stopAttemptIfRunning(false);
  stopGlobalTimer();

  const payload = buildPayload(reason);

  let submitOk = false;
  let submitMsg = "";

  if (ENDPOINT_URL){
    try{
      await fetch(ENDPOINT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
        keepalive: true
      });
      submitOk = true;
      submitMsg = "Résultats envoyés (enregistrement dans Sheets).";
    } catch(err){
      submitMsg = "Envoi échoué, passage quand même à l'étape 2.";
    }
  } else {
    submitMsg = "Aucun endpoint configuré, pas d'enregistrement serveur.";
  }

  const b = payload.best
    ? `Meilleur score conservé.\nNet WPM: ${payload.best.netWpm.toFixed(1)}\nPrécision: ${payload.best.accuracyPct.toFixed(1)}%\nErreurs: ${payload.best.errors}`
    : "Aucun essai complété.";

  setStatus(`${b}\n${submitMsg}\nRedirection vers l'étape 2...`, submitOk ? "ok" : "warn");

  navigateToStep(2);
}

function navigateToStep(step){
  state.step = step;
  setUrl(step, state.token);
  renderByStep(step);
}

function renderByStep(step){
  showStep(step);

  if (step === 2){
    document.getElementById("tokenStep2").textContent = state.token;
    startStep2Timer();
  } else {
    clearStep2Timer();
  }

  if (step === 3){
    document.getElementById("tokenStep3").textContent = state.token;
  }
}

function readFileAsBase64(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = String(reader.result || "");
      const comma = result.indexOf(",");
      resolve(comma >= 0 ? result.slice(comma + 1) : result);
    };
    reader.onerror = () => reject(reader.error || new Error("FileReader error"));
    reader.readAsDataURL(file);
  });
}

async function submitStep2File(){
  const fileInput = document.getElementById("step2File");
  const statusEl = document.getElementById("step2UploadStatus");

  if (!ENDPOINT_URL){
    statusEl.textContent = "ENDPOINT_URL n'est pas configuré.";
    return;
  }

  if (!fileInput || !fileInput.files || fileInput.files.length === 0){
    statusEl.textContent = "Choisis un fichier .docx avant de soumettre.";
    return;
  }

  const file = fileInput.files[0];
  if (!file.name.toLowerCase().endsWith(".docx")){
    statusEl.textContent = "Format invalide. Soumets un .docx.";
    return;
  }

  statusEl.textContent = "Envoi du fichier en cours...";

  try {
    const b64 = await readFileAsBase64(file);
    const id = loadIdentity();

    const payload = {
      token: state.token,
      step: 2,
      reason: "step2_upload",
      studentId: id ? id.studentId : "",
      firstName: id ? id.firstName : "",
      lastName: id ? id.lastName : "",
      best: bestAttempt(),
      attemptsCompleted: state.attemptsCompleted,
      attempts: state.attempts,
      focusLost: state.focusLost,
      totalTimeSec: state.globalStartMs ? getElapsedSec(state.globalStartMs) : null,
      userAgent: navigator.userAgent,
      file: {
        name: file.name,
        mimeType: file.type || "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        base64: b64
      }
    };

    await fetch(ENDPOINT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=UTF-8" },
      body: JSON.stringify(payload)
    });

    statusEl.textContent = "Soumission envoyée. Étape 3 débloquée.";
    const bTo3 = document.getElementById("btnToStep3");
    if (bTo3) bTo3.disabled = false;
    clearStep2Timer();
  } catch (err){
    statusEl.textContent = "Erreur lors de la soumission. Réessaie.";
  }
}

function init(){
  const urlToken = getUrlParam("token");
  const urlStep = parseInt(getUrlParam("step") || "1", 10);

  // Check for token in URL first
  if (urlToken) {
    state.token = urlToken;
    saveIdentity({
      token: urlToken,
      firstName: "",
      lastName: "",
      studentId: "Utilisateur"
    });
  } else if (isLoggedIn()) {
    const id = loadIdentity();
    state.token = id.token;
  } else {
    state.token = genToken();
  }

  updateLoginUI();

  window.addEventListener("blur", ()=>{ state.focusLost++; });

  const typingInput = document.getElementById("typingInput");
  typingInput.addEventListener("keydown", (e)=>{
    if (e.key === "Backspace") state.backspaces++;
    if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === "v")) {
      e.preventDefault();
      return false;
    }
  });
  typingInput.addEventListener("paste", (e)=>{
    e.preventDefault();
    return false;
  });

  setTargetText(0);

  // Login handlers
  document.getElementById("btnLogin").addEventListener("click", openModal);
  document.getElementById("loginPill").addEventListener("click", openModal);
  document.getElementById("btnCloseModal").addEventListener("click", closeModal);

  document.getElementById("loginForm").addEventListener("submit", (e)=>{
    e.preventDefault();

    const firstName = String(document.getElementById("modalFirstName").value || "").trim();
    const lastName  = String(document.getElementById("modalLastName").value || "").trim();
    const studentId = String(document.getElementById("modalStudentId").value || "").trim();

    if (!studentId){
      alert("Ajoute au moins un numéro étudiant ou un courriel.");
      return;
    }

    const cached = loadIdentity();
    const token = (cached && cached.token) || state.token;

    saveIdentity({ token, firstName, lastName, studentId });
    state.token = token;
    updateLoginUI();
    closeModal();
  });

  document.getElementById("btnConsoleAction").addEventListener("click", ()=>{
    if (isLoggedIn()) {
      clearIdentity();
      updateLoginUI();
    }
  });

  // Step 1 buttons
  document.getElementById("btnStart").addEventListener("click", ()=>{
    if (state.globalStartMs) return;

    if (!isLoggedIn()){
      alert("Connecte-toi d'abord via le bouton en haut.");
      openModal();
      return;
    }

    document.getElementById("btnStart").disabled = true;
    document.getElementById("btnForceSubmit").disabled = false;

    document.getElementById("kAttempt").textContent = `0 / ${MAX_ATTEMPTS}`;
    document.getElementById("kAttemptTime").textContent = String(ATTEMPT_DURATION_SEC);
    document.getElementById("kGlobalTime").textContent = String(GLOBAL_LIMIT_SEC);

    startGlobalTimer();
    startAttempt();
  });

  document.getElementById("btnFinish").addEventListener("click", ()=>{
    finishAttempt("manual_finish");
  });

  document.getElementById("btnNext").addEventListener("click", ()=>{
    if (state.attemptsCompleted >= MAX_ATTEMPTS) return;
    document.getElementById("typingInput").value = "";
    document.getElementById("kAttemptTime").textContent = String(ATTEMPT_DURATION_SEC);
    startAttempt();
  });

  document.getElementById("btnForceSubmit").addEventListener("click", ()=>{
    stopAttemptIfRunning(true);
    autoSubmit("manual_submit");
  });

  // Step navigation
  const bTo3 = document.getElementById("btnToStep3");
  if (bTo3) bTo3.addEventListener("click", ()=> navigateToStep(3));

  const bBack1 = document.getElementById("btnBackToStep1");
  if (bBack1) bBack1.addEventListener("click", ()=> navigateToStep(1));

  const bBack2 = document.getElementById("btnBackToStep2");
  if (bBack2) bBack2.addEventListener("click", ()=> navigateToStep(2));

  const btnUpload = document.getElementById("btnUploadStep2");
  if (btnUpload) btnUpload.addEventListener("click", submitStep2File);

  // Apply URL step
  state.step = [1,2,3].includes(urlStep) ? urlStep : 1;
  setUrl(state.step, state.token);
  renderByStep(state.step);
}

init();
</script>
</body>
</html>
